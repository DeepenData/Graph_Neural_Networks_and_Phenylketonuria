#densityHeatmap(t(processed_data),  ylim = c(0.02, 0.5),  ylab = "some values", show_quantiles = F, mc.cores =20, cores = 20,
#               cluster_columns = TRUE,  clustering_distance_columns  =  function(x) fastcluster::hclust(dist(x), "euclidean"))  %v%
ht <- Heatmap(t(processed_data),
clustering_distance_columns  =  function(x) fastcluster::hclust(dist(x), "euclidean"),
cluster_columns              =  function(x) fastcluster::hclust(dist(x), "complete"),
clustering_distance_rows  =  function(x) fastcluster::hclust(dist(x), "euclidean"),
cluster_rows              =  function(x) fastcluster::hclust(dist(x), "complete"),
name = "Edge weight",
border = TRUE,
row_km = 2,
column_km = 4,
row_gap = unit(2, "mm"),
column_gap = unit(2, "mm"),
width = unit(13, "cm"),
height = unit(5, "cm"),
show_column_names = F,
show_row_names = F,
column_title = c( "Edges from the metabolic network"),
column_title_gp = gpar(fontsize = 11),
row_title = c("Samples (patients)"),
row_title_gp = gpar(fontsize = 11),
row_dend_width    = unit(1.5, "cm"),
column_dend_height = unit(1.5,"cm"),
top_annotation = top_annotation,
right_annotation = right_annotation,
bottom_annotation = bottom_annotation, heatmap_legend_param = list(direction = "horizontal"))
heatmap_clusters <- waRRior::heatmap_extract_cluster(draw(ht), t(processed_data),  which = "column")
heatmap_clusters %>% count(Cluster, sort = TRUE) %>% .[['Cluster']] -> clusters_descending_sorted
clusters_descending_sorted[1:length(clusters_descending_sorted)] -> real_clusters
get_entrez_IDs_cluster <- function(a_cluster) {
edges_clusters   <-  heatmap_clusters[['Cluster']]
cluster_mask     <- edges_clusters ==a_cluster
genes_list       <- edges_genes_SAMPLE$genes[cluster_mask] %>% str_extract_all('\\d+(?=\\.)')
entrez_IDs       <- genes_list%>% unlist() %>% unique()
return(entrez_IDs)}
clusters <- unique(heatmap_clusters[['Cluster']])
lapply(clusters, get_entrez_IDs_cluster) %>% purrr::set_names(clusters) %>% .[real_clusters]  -> clusters_list # %>% purrr::set_names(c("C1", "C3", "C4")) -> clusters_list
ensembl    <- useMart("ensembl")
Hs.ensembl <- useMart("ensembl",dataset="hsapiens_gene_ensembl")
genes_symbols <- list()
get_functional_annots <- function(entrez_IDs, transporters){
temp <- getBM(attributes=c('hgnc_symbol',"entrezgene_id", 'entrezgene_description'),filters ='entrezgene_id',values =entrez_IDs, mart = Hs.ensembl)
if(transporters){
temp %<>% filter(str_detect(entrezgene_description,regex( '(solute.+?carrier)|transporter', ignore_case = T)))
}
else {  temp %<>% filter(!str_detect(entrezgene_description,regex( '(solute.+?carrier)|transporter', ignore_case = T))) }
return(arrange(temp, hgnc_symbol) %>% purrr::set_names(c("Symbol", "Entrez ID", "Description")))}
#%>% as_tibble() %>% nest(name_1006= name_1006) %>% mutate(name_1006 = name_1006) -> nested_df
transporters <- purrr::map2(clusters_list, c(T,T,T,T), get_functional_annots)
reactions    <- purrr::map2(clusters_list, c(F,F,F,F), get_functional_annots)
purrr::map2(reactions, c("Entrez ID","Entrez ID","Entrez ID","Entrez ID"), pull) %>%
compareCluster(fun='enrichKEGG', pvalueCutoff=1e-2, qvalueCutoff=1e-2)-> enrich_output
enrich_output %>% dotplot(showCategory = 10, font.size = 9, label_format =50)+
theme(
legend.text=element_text(size=6),
legend.position = "bottom",
#legend.box = "vertical",
text = element_text(size=6)) -> enrichKEGG_reactions
purrr::map2(reactions, c("Entrez ID","Entrez ID","Entrez ID","Entrez ID"), pull) %>% compareCluster(fun='enrichDGN', pvalueCutoff=1e-2,  qvalueCutoff=1e-2)-> enrich_output
enrich_output %>% dotplot(showCategory = 5, font.size = 9, label_format =40)+
theme(
legend.text=element_text(size=6),
legend.position = "bottom",
#legend.box = "vertical",
text = element_text(size=6))-> enrichDGN_reactions
purrr::map2(transporters, c("Entrez ID","Entrez ID","Entrez ID","Entrez ID"), pull) %>%
compareCluster(fun='enrichKEGG', pvalueCutoff=5e-2, qvalueCutoff=5e-2)-> enrich_output
enrich_output %>% dotplot(showCategory = 10, font.size = 9, label_format =50)+
theme(
legend.text=element_text(size=6),
legend.position = "bottom",
#legend.box = "vertical",
text = element_text(size=6)) -> enrichKEGG_transporters
purrr::map2(transporters, c("Entrez ID","Entrez ID","Entrez ID","Entrez ID"), pull) %>% compareCluster(fun='enrichDGN', pvalueCutoff=5e-2,  qvalueCutoff=5e-2)-> enrich_output
enrich_output %>% dotplot(showCategory = 5, font.size = 9, label_format =40)+
theme(
legend.text=element_text(size=6),
legend.position = "bottom",
#legend.box = "vertical",
text = element_text(size=6))-> enrichDGN_transporters
heatmap_ggploted <- ggplotify::as.ggplot((ht))
upper_enrich <- ggarrange(enrichKEGG_reactions, enrichDGN_reactions, nrow = 1, common.legend = T, labels = c("b","c")) %>% annotate_figure(left = text_grob("Reaction-related nodes", color = "black", rot = 90, face = "bold"))
lower_enrich <- ggarrange(enrichKEGG_transporters, enrichDGN_transporters, nrow = 1, common.legend = T, labels = c("d","e")) %>% annotate_figure(left = text_grob("Transport-related nodes", color = "black", rot = 90, face = "bold"))
enrich_panel <- ggarrange(upper_enrich, lower_enrich, common.legend = T, nrow = 2, heights = c(1.25,1))
ggarrange(heatmap_ggploted, enrich_panel, nrow = 2, heights = c(1, 1.2))
purrr::map2(reactions, c("Entrez ID","Entrez ID","Entrez ID","Entrez ID"), pull) %>%
compareCluster(fun='enrichKEGG', pvalueCutoff=1e-3, qvalueCutoff=1e-3)-> enrich_output
enrich_output %>% dotplot(showCategory = 10, font.size = 9, label_format =50)+
theme(
legend.text=element_text(size=6),
legend.position = "bottom",
#legend.box = "vertical",
text = element_text(size=6)) -> enrichKEGG_reactions
purrr::map2(reactions, c("Entrez ID","Entrez ID","Entrez ID","Entrez ID"), pull) %>% compareCluster(fun='enrichDGN', pvalueCutoff=1e-3,  qvalueCutoff=1e-3)-> enrich_output
enrich_output %>% dotplot(showCategory = 5, font.size = 9, label_format =40)+
theme(
legend.text=element_text(size=6),
legend.position = "bottom",
#legend.box = "vertical",
text = element_text(size=6))-> enrichDGN_reactions
upper_enrich <- ggarrange(enrichKEGG_reactions, enrichDGN_reactions, nrow = 1, common.legend = T, labels = c("b","c")) %>% annotate_figure(left = text_grob("Reaction-related nodes", color = "black", rot = 90, face = "bold"))
lower_enrich <- ggarrange(enrichKEGG_transporters, enrichDGN_transporters, nrow = 1, common.legend = T, labels = c("d","e")) %>% annotate_figure(left = text_grob("Transport-related nodes", color = "black", rot = 90, face = "bold"))
enrich_panel <- ggarrange(upper_enrich, lower_enrich, common.legend = T, nrow = 2, heights = c(1.25,1))
ggarrange(heatmap_ggploted, enrich_panel, nrow = 2, heights = c(1, 1.2))
purrr::map2(reactions, c("Entrez ID","Entrez ID","Entrez ID","Entrez ID"), pull) %>%
compareCluster(fun='enrichKEGG', pvalueCutoff=1e-3, qvalueCutoff=1e-3)-> enrich_output
enrich_output %>% dotplot(showCategory = 10, font.size = 9, label_format =50)+
theme(
legend.text=element_text(size=6),
legend.position = "bottom",
#legend.box = "vertical",
text = element_text(size=5)) -> enrichKEGG_reactions
purrr::map2(reactions, c("Entrez ID","Entrez ID","Entrez ID","Entrez ID"), pull) %>% compareCluster(fun='enrichDGN', pvalueCutoff=1e-3,  qvalueCutoff=1e-3)-> enrich_output
enrich_output %>% dotplot(showCategory = 5, font.size = 9, label_format =40)+
theme(
legend.text=element_text(size=6),
legend.position = "bottom",
#legend.box = "vertical",
text = element_text(size=5))-> enrichDGN_reactions
purrr::map2(transporters, c("Entrez ID","Entrez ID","Entrez ID","Entrez ID"), pull) %>%
compareCluster(fun='enrichKEGG', pvalueCutoff=5e-2, qvalueCutoff=5e-2)-> enrich_output
enrich_output %>% dotplot(showCategory = 10, font.size = 9, label_format =50)+
theme(
legend.text=element_text(size=6),
legend.position = "bottom",
#legend.box = "vertical",
text = element_text(size=5)) -> enrichKEGG_transporters
purrr::map2(transporters, c("Entrez ID","Entrez ID","Entrez ID","Entrez ID"), pull) %>% compareCluster(fun='enrichDGN', pvalueCutoff=5e-2,  qvalueCutoff=5e-2)-> enrich_output
enrich_output %>% dotplot(showCategory = 5, font.size = 9, label_format =40)+
theme(
legend.text=element_text(size=6),
legend.position = "bottom",
#legend.box = "vertical",
text = element_text(size=5))-> enrichDGN_transporters
upper_enrich <- ggarrange(enrichKEGG_reactions, enrichDGN_reactions, nrow = 1, common.legend = T, labels = c("b","c")) %>% annotate_figure(left = text_grob("Reaction-related nodes", color = "black", rot = 90, face = "bold"))
lower_enrich <- ggarrange(enrichKEGG_transporters, enrichDGN_transporters, nrow = 1, common.legend = T, labels = c("d","e")) %>% annotate_figure(left = text_grob("Transport-related nodes", color = "black", rot = 90, face = "bold"))
enrich_panel <- ggarrange(upper_enrich, lower_enrich, common.legend = T, nrow = 2, heights = c(1.25,1))
ggarrange(heatmap_ggploted, enrich_panel, nrow = 2, heights = c(1, 1.2))
enrichDGN_transporters
purrr::map2(transporters, c("Entrez ID","Entrez ID","Entrez ID","Entrez ID"), pull) %>% compareCluster(fun='enrichDGN', pvalueCutoff=5e-2,  qvalueCutoff=5e-2)-> enrich_output
enrich_output %>% dotplot(showCategory = 5, font.size = 9, label_format =40)+
theme(
legend.text=element_text(size=6),
legend.position = "bottom",
#legend.box = "vertical",
text = element_text(size=4))-> enrichDGN_transporters
purrr::map2(transporters, c("Entrez ID","Entrez ID","Entrez ID","Entrez ID"), pull) %>% compareCluster(fun='enrichDGN', pvalueCutoff=5e-2,  qvalueCutoff=5e-2)-> enrich_output
enrich_output %>% dotplot(showCategory = 5, font.size = 6, label_format =40)+
theme(
legend.text=element_text(size=6),
legend.position = "bottom",
#legend.box = "vertical",
text = element_text(size=4))-> enrichDGN_transporters
purrr::map2(transporters, c("Entrez ID","Entrez ID","Entrez ID","Entrez ID"), pull) %>% compareCluster(fun='enrichDGN', pvalueCutoff=5e-2,  qvalueCutoff=5e-2)-> enrich_output
enrich_output %>% dotplot(showCategory = 5, font.size = 7, label_format =40)+
theme(
legend.text=element_text(size=6),
legend.position = "bottom",
#legend.box = "vertical",
text = element_text(size=4))-> enrichDGN_transporters
purrr::map2(reactions, c("Entrez ID","Entrez ID","Entrez ID","Entrez ID"), pull) %>%
compareCluster(fun='enrichKEGG', pvalueCutoff=1e-3, qvalueCutoff=1e-3)-> enrich_output
enrich_output %>% dotplot(showCategory = 10, font.size = 7, label_format =50)+
theme(
legend.text=element_text(size=6),
legend.position = "bottom",
#legend.box = "vertical",
text = element_text(size=5)) -> enrichKEGG_reactions
purrr::map2(reactions, c("Entrez ID","Entrez ID","Entrez ID","Entrez ID"), pull) %>% compareCluster(fun='enrichDGN', pvalueCutoff=1e-3,  qvalueCutoff=1e-3)-> enrich_output
enrich_output %>% dotplot(showCategory = 5, font.size = 7, label_format =40)+
theme(
legend.text=element_text(size=6),
legend.position = "bottom",
#legend.box = "vertical",
text = element_text(size=5))-> enrichDGN_reactions
purrr::map2(transporters, c("Entrez ID","Entrez ID","Entrez ID","Entrez ID"), pull) %>%
compareCluster(fun='enrichKEGG', pvalueCutoff=5e-2, qvalueCutoff=5e-2)-> enrich_output
enrich_output %>% dotplot(showCategory = 10, font.size = 7, label_format =50)+
theme(
legend.text=element_text(size=6),
legend.position = "bottom",
#legend.box = "vertical",
text = element_text(size=5)) -> enrichKEGG_transporters
purrr::map2(transporters, c("Entrez ID","Entrez ID","Entrez ID","Entrez ID"), pull) %>% compareCluster(fun='enrichDGN', pvalueCutoff=5e-2,  qvalueCutoff=5e-2)-> enrich_output
enrich_output %>% dotplot(showCategory = 5, font.size = 7, label_format =40)+
theme(
legend.text=element_text(size=6),
legend.position = "bottom",
#legend.box = "vertical",
text = element_text(size=4))-> enrichDGN_transporters
upper_enrich <- ggarrange(enrichKEGG_reactions, enrichDGN_reactions, nrow = 1, common.legend = T, labels = c("b","c")) %>% annotate_figure(left = text_grob("Reaction-related nodes", color = "black", rot = 90, face = "bold"))
lower_enrich <- ggarrange(enrichKEGG_transporters, enrichDGN_transporters, nrow = 1, common.legend = T, labels = c("d","e")) %>% annotate_figure(left = text_grob("Transport-related nodes", color = "black", rot = 90, face = "bold"))
enrich_panel <- ggarrange(upper_enrich, lower_enrich, common.legend = T, nrow = 2, heights = c(1.25,1))
ggarrange(heatmap_ggploted, enrich_panel, nrow = 2, heights = c(1, 1.2))
upper_enrich <- ggarrange(enrichKEGG_reactions, enrichDGN_reactions, nrow = 1, common.legend = T, labels = c("b","c")) %>% annotate_figure(left = text_grob("Reaction-related nodes", color = "black", rot = 90, face = "bold"))
lower_enrich <- ggarrange(enrichKEGG_transporters, enrichDGN_transporters, nrow = 1, common.legend = T, labels = c("d","e")) %>% annotate_figure(left = text_grob("Transport-related nodes", color = "black", rot = 90, face = "bold"))
enrich_panel <- ggarrange(upper_enrich, lower_enrich, common.legend = T, nrow = 2, heights = c(1.25,1))
ggarrange(heatmap_ggploted, enrich_panel, nrow = 2, heights = c(1, 1.2))
upper_enrich <- ggarrange(enrichKEGG_reactions, enrichDGN_reactions, nrow = 1, common.legend = T, labels = c("b","c")) %>% annotate_figure(left = text_grob("Reaction-related nodes", color = "black", rot = 90, face = "bold"))
lower_enrich <- ggarrange(enrichKEGG_transporters, enrichDGN_transporters, nrow = 1, common.legend = T, labels = c("d","e")) %>% annotate_figure(left = text_grob("Transport-related nodes", color = "black", rot = 90, face = "bold"))
enrich_panel <- ggarrange(upper_enrich, lower_enrich, common.legend = T, nrow = 2, heights = c(1.25,1))
ggarrange(heatmap_ggploted, enrich_panel, nrow = 2, heights = c(1, 1.2))
upper_enrich <- ggarrange(enrichKEGG_reactions, enrichDGN_reactions, nrow = 1, common.legend = T, labels = c("b","c")) %>% annotate_figure(left = text_grob("Reaction-related nodes", color = "black", rot = 90, face = "bold"))
lower_enrich <- ggarrange(enrichKEGG_transporters, enrichDGN_transporters, nrow = 1, common.legend = T, labels = c("d","e")) %>% annotate_figure(left = text_grob("Transport-related nodes", color = "black", rot = 90, face = "bold"))
enrich_panel <- ggarrange(upper_enrich, lower_enrich, common.legend = T, nrow = 2, heights = c(1.25,1))
ggarrange(heatmap_ggploted, enrich_panel, nrow = 2, heights = c(1, 1.3))
upper_enrich <- ggarrange(enrichKEGG_reactions, enrichDGN_reactions, nrow = 1, common.legend = T, labels = c("b","c")) %>% annotate_figure(left = text_grob("Reaction-related nodes", color = "black", rot = 90, face = "bold"))
lower_enrich <- ggarrange(enrichKEGG_transporters, enrichDGN_transporters, nrow = 1, common.legend = T, labels = c("d","e")) %>% annotate_figure(left = text_grob("Transport-related nodes", color = "black", rot = 90, face = "bold"))
enrich_panel <- ggarrange(upper_enrich, lower_enrich, common.legend = T, nrow = 2, heights = c(1.3,1))
ggarrange(heatmap_ggploted, enrich_panel, nrow = 2, heights = c(1, 1.3))
upper_enrich <- ggarrange(enrichKEGG_reactions, enrichDGN_reactions, nrow = 1, common.legend = T, labels = c("b","c")) %>% annotate_figure(left = text_grob("Reaction-related nodes", color = "black", rot = 90, face = "bold"))
lower_enrich <- ggarrange(enrichKEGG_transporters, enrichDGN_transporters, nrow = 1, common.legend = T, labels = c("d","e")) %>% annotate_figure(left = text_grob("Transport-related nodes", color = "black", rot = 90, face = "bold"))
enrich_panel <- ggarrange(upper_enrich, lower_enrich, common.legend = T, nrow = 2, heights = c(1.3,1))
ggarrange(heatmap_ggploted, enrich_panel, nrow = 2, heights = c(1, 1.35))
upper_enrich <- ggarrange(enrichKEGG_reactions, enrichDGN_reactions, nrow = 1, common.legend = T, labels = c("b","c")) %>% annotate_figure(left = text_grob("Reaction-related nodes", color = "black", rot = 90, face = "bold"))
lower_enrich <- ggarrange(enrichKEGG_transporters, enrichDGN_transporters, nrow = 1, common.legend = T, labels = c("d","e")) %>% annotate_figure(left = text_grob("Transport-related nodes", color = "black", rot = 90, face = "bold"))
enrich_panel <- ggarrange(upper_enrich, lower_enrich, common.legend = T, nrow = 2, heights = c(1.3,1))
ggarrange(heatmap_ggploted, enrich_panel, nrow = 2, heights = c(1, 1.45))
upper_enrich <- ggarrange(enrichKEGG_reactions, enrichDGN_reactions, nrow = 1, common.legend = T, labels = c("b","c")) %>% annotate_figure(left = text_grob("Reaction-related nodes", color = "black", rot = 90, face = "bold"))
lower_enrich <- ggarrange(enrichKEGG_transporters, enrichDGN_transporters, nrow = 1, common.legend = T, labels = c("d","e")) %>% annotate_figure(left = text_grob("Transport-related nodes", color = "black", rot = 90, face = "bold"))
enrich_panel <- ggarrange(upper_enrich, lower_enrich, common.legend = T, nrow = 2, heights = c(1.3,1))
ggarrange(heatmap_ggploted, enrich_panel, nrow = 2, heights = c(1, 1.4))
upper_enrich <- ggarrange(enrichKEGG_reactions, enrichDGN_reactions, nrow = 1, common.legend = T, labels = c("b","c")) %>% annotate_figure(left = text_grob("Reaction-related nodes", color = "black", rot = 90, face = "bold"))
lower_enrich <- ggarrange(enrichKEGG_transporters, enrichDGN_transporters, nrow = 1, common.legend = T, labels = c("d","e")) %>% annotate_figure(left = text_grob("Transport-related nodes", color = "black", rot = 90, face = "bold"))
enrich_panel <- ggarrange(upper_enrich, lower_enrich, common.legend = T, nrow = 2, heights = c(1.3,1))
ggarrange(heatmap_ggploted, enrich_panel, nrow = 2, heights = c(1, 1.4), labels = c("a",""))
library(arrow)
library(tidyverse)
library(ComplexHeatmap)
library(scales)
library(ggpubr)
library(ggplot2)
library(DOSE)
library(magrittr)
library(biomaRt)
library(tidyverse)
library(clusterProfiler)
library(ReactomePA)
library(org.Hs.eg.db)
library(fastcluster)
setwd("/DeepenData/Repos/geometric_cobra")
df     <-  read_csv("./results/dataframes/Non_masked_results_for_Heatmaps.csv") %>% dplyr::select(-c("...1"))
labels <- read_csv("./results/dataframes/Non_Masked_train_labels.csv")  %>%  dplyr::select(-c("...1")) %>% .[[1]]
edge_weights_x_patients <- df%>%  dplyr::select_if(is.numeric)
edges_genes   <- df%>%  dplyr::select_if(is.character)
n_edges <- nrow(edges_genes)
n_patients <- length(labels)
edges_mask    <- sample(c(T,F), n_edges, replace = T, prob = c(1, 0))
patients_mask <- sample(c(T,F), n_patients, replace = T, prob = c(.5, 0.5))
edge_weights_x_patients_SAMPLE <- edge_weights_x_patients[edges_mask,patients_mask]
labels_SAMPLE <- labels[patients_mask]
edges_genes_SAMPLE <- edges_genes[edges_mask,]
processed_data <- edge_weights_x_patients_SAMPLE %>% as.matrix() %>% rescale
dim(processed_data)
#view(edges_genes)
library(tidyverse)
setwd("/DeepenData/Repos/geometric_cobra")
df1 <-read_csv2("./metabolites_data/Base_de_datos_2010_2020_columnas_limpias.csv")
library(magrittr)
vars_to_drop_NAs <- c("Fecha entrega informe","Fecha de nacimiento","Phe","tir", "Edad (días calculados)")
df1 %>% drop_na(any_of(vars_to_drop_NAs))  %>%
filter( (0 < tir)) %>%
filter( (0 < Phe) & (Phe < 120))  %>%
filter(`Edad (días calculados)` <= 31) %>%
select(-c("FDIAG")) %>%
mutate(`Fecha entrega informe` = as.Date(`Fecha entrega informe`,"%d-%m-%Y"))  %>%
mutate(`Fecha de nacimiento` = as.Date(`Fecha de nacimiento`,"%d-%m-%Y")) %>%
filter(`Fecha entrega informe` > '2009-01-01')-> healthy
#healthy$Condicion <- "Control"
to_drop <- c( "RUT","Fecha entrega informe", "Fecha de nacimiento",    "estudio molecular",      "Ciudad",                 "Sexo" ,
"Edad (días calculados)", "FADIAG (mg por dL)",     "TIRDIAG mg_por_DL" ,     "razon_FADIAG_TIRDIAG" ,  "COMUNA",
"REGION"         ,        "TDIAG")
healthy_numeric <- healthy %>% select(-c(to_drop)) %>% select_if(is_double)
#healthy_numeric$Glt[
#which.max(healthy_numeric$Glt)] <- NA
#%>%as.data.frame() %>% ggplot(aes(x=V1)) + geom_histogram()
check_in <- function(a_row){
return("out" %in% a_row) }
find_out_occurences <- function(df){
return(sapply(as.list(as.data.frame(t(df))), check_in) %>% as.vector())
}
df <- data.frame(x = 1:5, y = 3:7, z = c(.01, .2,.4,1, 3e5))
df[2,2] <- NA
df[4,1] <- NA
df[2,1] <- NA
df
outliers_to_str <- function(a_col){
Q1 <- quantile(a_col, 0.15, names = FALSE, na.rm =T)
Q3 <- quantile(a_col, 0.85, names = FALSE, na.rm =T)
INTER <- Q3 - Q1
lower_bound <- Q1 - 1.5*INTER
upper_bound <- Q3 + 1.5*INTER
#mask <- (a_col < lower_bound) & (a_col > upper_bound)
a_col[a_col < lower_bound | a_col > upper_bound] <- "out"
return(a_col)
}
df%>% mutate_all(outliers_to_str)  %>% find_out_occurences  -> out_ocurrences
df[!out_ocurrences,]
healthy_numeric%>% mutate_all(outliers_to_str)  %>% find_out_occurences  -> out_ocurrences
healthy_numeric[!out_ocurrences,] -> healthy_dropped_patients
library(ggbeeswarm)
plot_swarm <- function(df){
df%>% pivot_longer(everything()) -> long
ggplot(long,aes(name, value)) + geom_quasirandom(size=.1, alpha = 0.05) -> my_plot
return(my_plot)
}
healthy_dropped_patients %>%
summarise(across(where(is.double),  ~ mean(.x, na.rm = TRUE))) %>% t -> vars_mean
q_25 <- quantile(vars_mean, 0.25, na.rm = TRUE)[[1]]
q_50 <- quantile(vars_mean, 0.5, na.rm = TRUE)[[1]]
q_75 <- quantile(vars_mean, 0.75, na.rm = TRUE)[[1]]
vars_q_1 <- vars_mean[vars_mean < q_25,] %>% names
vars_q_2 <- vars_mean[q_25 <= vars_mean & vars_mean < q_50,] %>% names
vars_q_3 <- vars_mean[q_50 <= vars_mean &   vars_mean < q_75,] %>% names
vars_q_4 <- vars_mean[q_75 <= vars_mean ,] %>% names
healthy_dropped_patients[vars_q_1] %>% plot_swarm -> vars_q_1_PLOT
healthy_dropped_patients[vars_q_2] %>% plot_swarm -> vars_q_2_PLOT
healthy_dropped_patients[vars_q_3] %>% plot_swarm -> vars_q_3_PLOT
healthy_dropped_patients[vars_q_4] %>% plot_swarm -> vars_q_4_PLOT
#a_col%>%as.data.frame() %>% ggplot(aes(x= . )) + geom_histogram()
library(ggpubr)
ggarrange(vars_q_1_PLOT, vars_q_2_PLOT, vars_q_3_PLOT, vars_q_4_PLOT,
ncol = 1) -> my_panel
my_panel
healthy_dropped_patients
library(tidyverse)
setwd("/DeepenData/Repos/geometric_cobra")
df1 <-read_csv2("./metabolites_data/Base_de_datos_2010_2020_columnas_limpias.csv")
library(magrittr)
vars_to_drop_NAs <- c("Fecha entrega informe","Fecha de nacimiento","Phe","tir", "Edad (días calculados)")
df1 %>% drop_na(any_of(vars_to_drop_NAs))  %>%
filter( (0 < tir)) %>%
filter( (0 < Phe) & (Phe < 120))  %>%
filter(`Edad (días calculados)` <= 31) %>%
select(-c("FDIAG")) %>%
mutate(`Fecha entrega informe` = as.Date(`Fecha entrega informe`,"%d-%m-%Y"))  %>%
mutate(`Fecha de nacimiento` = as.Date(`Fecha de nacimiento`,"%d-%m-%Y")) %>%
filter(`Fecha entrega informe` > '2009-01-01')-> healthy
#healthy$Condicion <- "Control"
to_drop <- c( "RUT","Fecha entrega informe", "Fecha de nacimiento",    "estudio molecular",      "Ciudad",                 "Sexo" ,
"Edad (días calculados)", "FADIAG (mg por dL)",     "TIRDIAG mg_por_DL" ,     "razon_FADIAG_TIRDIAG" ,  "COMUNA",
"REGION"         ,        "TDIAG")
healthy_numeric <- healthy %>% select(-c(to_drop)) %>% select_if(is_double)
#healthy_numeric$Glt[
#which.max(healthy_numeric$Glt)] <- NA
#%>%as.data.frame() %>% ggplot(aes(x=V1)) + geom_histogram()
check_in <- function(a_row){
return("out" %in% a_row) }
find_out_occurences <- function(df){
return(sapply(as.list(as.data.frame(t(df))), check_in) %>% as.vector())
}
df <- data.frame(x = 1:5, y = 3:7, z = c(.01, .2,.4,1, 3e5))
df[2,2] <- NA
df[4,1] <- NA
df[2,1] <- NA
df
outliers_to_str <- function(a_col){
Q1 <- quantile(a_col, 0.20, names = FALSE, na.rm =T)
Q3 <- quantile(a_col, 0.80, names = FALSE, na.rm =T)
INTER <- Q3 - Q1
lower_bound <- Q1 - 1.5*INTER
upper_bound <- Q3 + 1.5*INTER
#mask <- (a_col < lower_bound) & (a_col > upper_bound)
a_col[a_col < lower_bound | a_col > upper_bound] <- "out"
return(a_col)
}
df%>% mutate_all(outliers_to_str)  %>% find_out_occurences  -> out_ocurrences
df[!out_ocurrences,]
healthy_numeric%>% mutate_all(outliers_to_str)  %>% find_out_occurences  -> out_ocurrences
healthy_numeric[!out_ocurrences,] -> healthy_dropped_patients
library(ggbeeswarm)
plot_swarm <- function(df){
df%>% pivot_longer(everything()) -> long
ggplot(long,aes(name, value)) + geom_quasirandom(size=.1, alpha = 0.05) -> my_plot
return(my_plot)
}
healthy_dropped_patients %>%
summarise(across(where(is.double),  ~ mean(.x, na.rm = TRUE))) %>% t -> vars_mean
q_25 <- quantile(vars_mean, 0.25, na.rm = TRUE)[[1]]
q_50 <- quantile(vars_mean, 0.5, na.rm = TRUE)[[1]]
q_75 <- quantile(vars_mean, 0.75, na.rm = TRUE)[[1]]
vars_q_1 <- vars_mean[vars_mean < q_25,] %>% names
vars_q_2 <- vars_mean[q_25 <= vars_mean & vars_mean < q_50,] %>% names
vars_q_3 <- vars_mean[q_50 <= vars_mean &   vars_mean < q_75,] %>% names
vars_q_4 <- vars_mean[q_75 <= vars_mean ,] %>% names
healthy_dropped_patients[vars_q_1] %>% plot_swarm -> vars_q_1_PLOT
healthy_dropped_patients[vars_q_2] %>% plot_swarm -> vars_q_2_PLOT
healthy_dropped_patients[vars_q_3] %>% plot_swarm -> vars_q_3_PLOT
healthy_dropped_patients[vars_q_4] %>% plot_swarm -> vars_q_4_PLOT
#a_col%>%as.data.frame() %>% ggplot(aes(x= . )) + geom_histogram()
library(ggpubr)
ggarrange(vars_q_1_PLOT, vars_q_2_PLOT, vars_q_3_PLOT, vars_q_4_PLOT,
ncol = 1) -> my_panel
my_panel
healthy_dropped_patients
library(mixgb)
for_mixgb <- data_clean(healthy_dropped_patients)
names(for_mixgb) <- make.names(colnames(for_mixgb))
imputed.data <- mixgb(data = for_mixgb, m = 1, nthread = 20)
imputed.data
imputed.data[[1]]%>% plot_swarm
library(mixgb)
for_mixgb <- data_clean(healthy_dropped_patients)
names(for_mixgb) <- make.names(colnames(for_mixgb))
imputed.data <- mixgb(data = for_mixgb, m = 1, nthread = 20)
imputed.data[[1]]%>% plot_swarm
library(mixgb)
for_mixgb <- data_clean(healthy_dropped_patients)
names(for_mixgb) <- make.names(colnames(for_mixgb))
imputed.data <- mixgb(data = for_mixgb, m = 1, nthread = 20)
imputed.data[[1]] %>%
summarise(across(where(is.double),  ~ mean(.x, na.rm = TRUE))) %>% t -> vars_mean
q_25 <- quantile(vars_mean, 0.25, na.rm = TRUE)[[1]]
q_50 <- quantile(vars_mean, 0.5, na.rm = TRUE)[[1]]
q_75 <- quantile(vars_mean, 0.75, na.rm = TRUE)[[1]]
vars_q_1 <- vars_mean[vars_mean < q_25,] %>% names
vars_q_2 <- vars_mean[q_25 <= vars_mean & vars_mean < q_50,] %>% names
vars_q_3 <- vars_mean[q_50 <= vars_mean &   vars_mean < q_75,] %>% names
vars_q_4 <- vars_mean[q_75 <= vars_mean ,] %>% names
imputed.data[[1]][vars_q_1] %>% plot_swarm -> vars_q_1_PLOT
vars_mean
imputed.data[1][vars_q_1] %>% plot_swarm -> vars_q_1_PLOT
imputed.data[1]
imputed.data[1][vars_q_1]
vars_q_1
imputed.data[[1]]
vars_q_1
imputed.data[1]
imputed.data[1][vars_q_1]
imputed_data %>%
summarise(across(where(is.double),  ~ mean(.x, na.rm = TRUE))) %>% t -> vars_mean
imputed_data <-imputed.data[[1]]
imputed_data %>%
summarise(across(where(is.double),  ~ mean(.x, na.rm = TRUE))) %>% t -> vars_mean
q_25 <- quantile(vars_mean, 0.25, na.rm = TRUE)[[1]]
q_50 <- quantile(vars_mean, 0.5, na.rm = TRUE)[[1]]
q_75 <- quantile(vars_mean, 0.75, na.rm = TRUE)[[1]]
vars_q_1 <- vars_mean[vars_mean < q_25,] %>% names
vars_q_2 <- vars_mean[q_25 <= vars_mean & vars_mean < q_50,] %>% names
vars_q_3 <- vars_mean[q_50 <= vars_mean &   vars_mean < q_75,] %>% names
vars_q_4 <- vars_mean[q_75 <= vars_mean ,] %>% names
imputed_data[vars_q_1] %>% plot_swarm -> vars_q_1_PLOT
imputed_data[vars_q_1]
imputed_data
imputed_data <-imputed.data[[1]] %>% as.data.frame()
imputed_data
imputed_data <-imputed.data[[1]] %>% as.data.frame()
imputed_data %>%
summarise(across(where(is.double),  ~ mean(.x, na.rm = TRUE))) %>% t -> vars_mean
q_25 <- quantile(vars_mean, 0.25, na.rm = TRUE)[[1]]
q_50 <- quantile(vars_mean, 0.5, na.rm = TRUE)[[1]]
q_75 <- quantile(vars_mean, 0.75, na.rm = TRUE)[[1]]
vars_q_1 <- vars_mean[vars_mean < q_25,] %>% names
vars_q_2 <- vars_mean[q_25 <= vars_mean & vars_mean < q_50,] %>% names
vars_q_3 <- vars_mean[q_50 <= vars_mean &   vars_mean < q_75,] %>% names
vars_q_4 <- vars_mean[q_75 <= vars_mean ,] %>% names
imputed_data[vars_q_1] %>% plot_swarm -> vars_q_1_PLOT
library(mixgb)
for_mixgb <- data_clean(healthy_dropped_patients)
names(for_mixgb) <- make.names(colnames(for_mixgb))
imputed.data <- mixgb(data = for_mixgb, m = 1, nthread = 20)
imputed_data <-imputed.data[[1]] %>% as.data.frame()
imputed_data %>%
summarise(across(where(is.double),  ~ mean(.x, na.rm = TRUE))) %>% t -> vars_mean
q_25 <- quantile(vars_mean, 0.25, na.rm = TRUE)[[1]]
q_50 <- quantile(vars_mean, 0.5, na.rm = TRUE)[[1]]
q_75 <- quantile(vars_mean, 0.75, na.rm = TRUE)[[1]]
vars_q_1 <- vars_mean[vars_mean < q_25,] %>% names
vars_q_2 <- vars_mean[q_25 <= vars_mean & vars_mean < q_50,] %>% names
vars_q_3 <- vars_mean[q_50 <= vars_mean &   vars_mean < q_75,] %>% names
vars_q_4 <- vars_mean[q_75 <= vars_mean ,] %>% names
imputed_data[vars_q_1] %>% plot_swarm -> vars_q_1_PLOT
imputed_data[vars_q_2] %>% plot_swarm -> vars_q_2_PLOT
imputed_data[vars_q_3] %>% plot_swarm -> vars_q_3_PLOT
imputed_data[vars_q_4] %>% plot_swarm -> vars_q_4_PLOT
#a_col%>%as.data.frame() %>% ggplot(aes(x= . )) + geom_histogram()
library(ggpubr)
ggarrange(vars_q_1_PLOT, vars_q_2_PLOT, vars_q_3_PLOT, vars_q_4_PLOT,
ncol = 1) -> my_panel
my_panel
library(mixgb)
for_mixgb <- data_clean(healthy_dropped_patients)
names(for_mixgb) <- make.names(colnames(for_mixgb))
imputed.data <- mixgb(data = for_mixgb, m = 1, nthread = 20)
imputed_data <-imputed.data[[1]] %>% as.data.frame()
imputed_data %>%
summarise(across(where(is.double),  ~ mean(.x, na.rm = TRUE))) %>% t -> vars_mean
q_25 <- quantile(vars_mean, 0.25, na.rm = TRUE)[[1]]
q_50 <- quantile(vars_mean, 0.5, na.rm = TRUE)[[1]]
q_75 <- quantile(vars_mean, 0.75, na.rm = TRUE)[[1]]
vars_q_1 <- vars_mean[vars_mean < q_25,] %>% names
vars_q_2 <- vars_mean[q_25 <= vars_mean & vars_mean < q_50,] %>% names
vars_q_3 <- vars_mean[q_50 <= vars_mean &   vars_mean < q_75,] %>% names
vars_q_4 <- vars_mean[q_75 <= vars_mean ,] %>% names
imputed_data[vars_q_1] %>% plot_swarm -> vars_q_1_PLOT
imputed_data[vars_q_2] %>% plot_swarm -> vars_q_2_PLOT
imputed_data[vars_q_3] %>% plot_swarm -> vars_q_3_PLOT
imputed_data[vars_q_4] %>% plot_swarm -> vars_q_4_PLOT
#a_col%>%as.data.frame() %>% ggplot(aes(x= . )) + geom_histogram()
library(ggpubr)
ggarrange(vars_q_1_PLOT, vars_q_2_PLOT, vars_q_3_PLOT, vars_q_4_PLOT,
ncol = 1) -> my_panel
my_panel
imputed_data
imputed_data %>% is.nan()
imputed_data
imputed_data %>% is.na()
imputed_data %>% is.na() %>% sum
imputed_data %>% is.na() %>% colSums()
imputed_data %>% is.na() %>% colSums()
dim(imputed_data)
setwd("/DeepenData/Repos/geometric_cobra")
