---
title: "R Notebook"
output: html_notebook
---
```{r message=FALSE, warning=FALSE}
library(arrow)
library(tidyverse)
library(ComplexHeatmap) 
library(scales)
library(ggpubr)
library(ggplot2)
library(DOSE)
library(magrittr)
library(biomaRt)
library(tidyverse)
library(clusterProfiler)
library(ReactomePA)
library(org.Hs.eg.db)
setwd("/DeepenData/Repos/geometric_cobra")
df <- read_csv("./results/data/Masked_results_for_R.csv") %>% dplyr::select(-c("...1"))
labels <- read_csv("./results/data/results_for_R_labels.csv") %>%  dplyr::select(-c("...1")) %>% .[[1]]
edge_weights_x_patients <- df%>%  dplyr::select_if(is.numeric)
edges_genes   <- df%>%  dplyr::select_if(is.character)
n_edges <- nrow(edges_genes)
n_patients <- length(labels)
```


```{r}
#view(edges_genes)

```


```{r}
edges_mask    <- sample(c(T,F), n_edges, replace = T, prob = c(1, 0))
patients_mask <- sample(c(T,F), n_patients, replace = T, prob = c(.3, .7))
edge_weights_x_patients_SAMPLE <- edge_weights_x_patients[edges_mask,patients_mask]
labels_SAMPLE <- labels[patients_mask]
edges_genes_SAMPLE <- edges_genes[edges_mask,]
processed_data <- edge_weights_x_patients_SAMPLE %>% as.matrix() %>% scale %>% rescale
dim(processed_data)
```


```{r}
right_annotation = rowAnnotation(Phenotype = labels_SAMPLE)
ht <- Heatmap(t(processed_data), row_km = 2, column_km = 4,  show_column_names = F, show_row_names = F, right_annotation= right_annotation)
heatmap_clusters <- waRRior::heatmap_extract_cluster(draw(ht), t(processed_data),  which = "column")

```
```{r}
get_entrez_IDs_cluster <- function(a_cluster) {
  
                                                edges_clusters   <-  heatmap_clusters[['Cluster']]
                                                cluster_mask     <- edges_clusters ==a_cluster
                                                
                                                genes_list       <- edges_genes_SAMPLE$genes[cluster_mask] %>% str_extract_all('\\d+(?=\\.)')
                                                entrez_IDs       <- genes_list%>% unlist() %>% unique()
                                                return(entrez_IDs)}


clusters <- unique(heatmap_clusters[['Cluster']])
lapply(clusters, get_entrez_IDs_cluster) %>% purrr::set_names(clusters) -> clusters_list
clusters_list[c("4","3","2")] %>% compareCluster(fun='enrichPathway', pvalueCutoff=1e-2)-> enrich_output
```


```{r fig.height=3, fig.width=4, message=FALSE, warning=FALSE}


enrich_output %>% dotplot(showCategory = 5, font.size = 7, label_format =35)
```



```{r fig.height=3, fig.width=4}
clusters_list[c("4","3","2")] %>% compareCluster(fun='enrichKEGG', pvalueCutoff=1e-2)-> enrich_output


enrich_output %>% dotplot(showCategory = 7, font.size = 7, label_format =35)
```
```{r fig.height=3, fig.width=4}
clusters_list[c("4","3","2")] %>% compareCluster(fun='enrichDGN', pvalueCutoff=1e-2)-> enrich_output
```


```{r fig.height=3, fig.width=4}
enrich_output %>% dotplot(showCategory = 6, font.size = 7, label_format =35)
```




















