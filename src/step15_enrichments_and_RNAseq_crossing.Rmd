---
title: "R Notebook"
output: html_notebook
---

```{r message=FALSE, warning=FALSE}
library(arrow)
library(tidyverse)
library(ComplexHeatmap) 
library(scales)
library(ggpubr)
library(ggplot2)
library(DOSE)
library(magrittr)
library(biomaRt)
library(tidyverse)
library(clusterProfiler)
library(ReactomePA)
library(org.Hs.eg.db)
library(fastcluster)
```


```{r message=FALSE, warning=FALSE}
setwd("/DeepenData/Repos/geometric_cobra")
C_genes  <- read_csv( "./results/explanations/to_GraphTools_visualization_explanatory_subgraph_MASKED_GIN_Concentration.csv")    %>%  .[['genes']]  %>% str_extract_all('\\d+(?=\\.)') %>% unlist() %>% unique()
F_genes  <- read_csv( "./results/explanations/to_GraphTools_visualization_explanatory_subgraph_MASKED_GIN_FLUX.csv")    %>%  .[['genes']]  %>% str_extract_all('\\d+(?=\\.)') %>% unlist() %>% unique()
CF_genes <- read_csv( "./results/explanations/to_GraphTools_visualization_explanatory_subgraph_MASKED_GIN_Concen_plus_Fluxes.csv")    %>%  .[['genes']]  %>% str_extract_all('\\d+(?=\\.)') %>% unlist() %>% unique()
```


```{r message=FALSE, warning=FALSE}
ensembl    <- useMart("ensembl")
Hs.ensembl <- useMart("ensembl",dataset="hsapiens_gene_ensembl")
genes_symbols <- list()
get_functional_annots <- function(entrez_IDs, transporters = F){
                                   temp <- getBM(attributes=c('hgnc_symbol',"entrezgene_id", 'entrezgene_description'),filters ='entrezgene_id',values =entrez_IDs, mart = Hs.ensembl)
                                   if(transporters){
                                     temp %<>% filter(str_detect(entrezgene_description,regex( '(solute.+?carrier)|transporter|aquapor|transport', ignore_case = T))) 
                                   }
                                   else {  temp %<>% filter(!str_detect(entrezgene_description,regex( '(solute.+?carrier)|transporter|aquapor|transport', ignore_case = T))) }
                                   
                                   
                                   
                                   return(arrange(temp, hgnc_symbol) %>% purrr::set_names(c("Symbol", "Entrez ID", "Description")))}



get_transporters_and_reactions <- function(genes_entrez){
                                            reactions    <- get_functional_annots(genes_entrez, transporters = F) 
                                            transporters <- get_functional_annots(genes_entrez, transporters = T) 
                                            
                                            transporters_and_reactions <- list('reactions'=reactions,'transporters'=transporters)
                                            return(transporters_and_reactions)}

get_two_Entrez_gene_lists <- function(rxns_and_transps_list){
                            return(list(rxns_and_transps_list$reactions$`Entrez ID`, rxns_and_transps_list$transporters$`Entrez ID`) %>% purrr::set_names(c("rxns", "trns"))
)
}

get_transporters_and_reactions(C_genes) ->  Concentration_rxns_and_transps
get_transporters_and_reactions(F_genes) ->  Flux_rxns_and_transps
get_transporters_and_reactions(CF_genes) -> FluxConcentration_rxns_and_transps
```
```{r message=FALSE, warning=FALSE}
setwd("/DeepenData/Repos/geometric_cobra/")
res <- readRDS("./results/genes/RNA_results.RDS")
res %>% rownames() -> all_ENSMUST
```


```{r message=FALSE, warning=FALSE}
Hs.ensembl       <- useMart("ensembl",dataset="hsapiens_gene_ensembl")
Mm.ensembl       <- useMart("ensembl",dataset="mmusculus_gene_ensembl")
temp_1           <- getBM(attributes=c('ensembl_transcript_id','hsapiens_homolog_ensembl_gene'),filters ='ensembl_transcript_id',values =all_ENSMUST, mart = Mm.ensembl)
colnames(temp_1) <- c("mouse_ensembl_transcript_id", "hsapiens_ensembl")
temp_2           <- getBM(attributes=c('ensembl_gene_id','hgnc_symbol','entrezgene_id','entrezgene_description'), 
                    filters ='ensembl_gene_id',values = temp_1$hsapiens_ensembl, mart = Hs.ensembl)


colnames(temp_2)           <- c("hsapiens_ensembl", "hgnc_symbol", "entrezgene_id", 'description')

inner_join(temp_1, temp_2) -> all_gene_codes
res['mouse_ensembl_transcript_id'] <- rownames(res)


inner_join(as.data.frame(res) ,all_gene_codes ) %>% drop_na() %>% arrange(hgnc_symbol) -> annotated_results
```

```{r}
library(EnhancedVolcano)
library(magrittr)

get_processed_results <- function(annotated_results, subset){
  annotated_results %>% dplyr::filter(entrezgene_id %in% subset) %>% dplyr::select(-c(mouse_ensembl_transcript_id,hsapiens_ensembl,entrezgene_id, description)) %>%
  group_by(hgnc_symbol) %>% summarise_all(median,  na.rm = TRUE) ->processed_results
  return(processed_results)
}




make_volcano <- function(df_res,labSize, subtitle, pValue_cutoff     = 0.05, FoldChnage_cutoff = .1){plot <- EnhancedVolcano(
        df_res, 
        x = 'log2FoldChange',
        y = 'padj',
        title = NULL,
        subtitle = subtitle,#paste0( names( conjuntos )[[i]], " - ", length( unique(conjuntos[[i]][ conjuntos[[i]] %in% df_res$gene_symbol_sig ]) ), " trancripts" ),
        pCutoff = pValue_cutoff,
        FCcutoff = FoldChnage_cutoff,
        pointSize = 3,
        lab = df_res$hgnc_symbol,
        #legendPosition = 'right',
        labSize = labSize,
        boxedLabels = T,
        drawConnectors = TRUE,
        widthConnectors = 0.2,
        colConnectors = 'black',
        max.overlaps = 200, #Inf,
    )+ ggthemes::theme_few() #+ 
    # coord_flip() + 
    #theme(legend.position="bottom")
    return(plot)}
```


```{r fig.height=4, fig.width=7, message=FALSE, warning=FALSE}
make_volcano_panel <- function(rxns_and_transps, labSize_1 =3, labSize_2=3,  widths = c(1,.5), pValue_cutoff = 0.05, common.legend.pos = 'top'){
                                  get_processed_results(annotated_results, rxns_and_transps %>% get_two_Entrez_gene_lists %>% .[['rxns']]) -> Flux_rxns
                                  get_processed_results(annotated_results, rxns_and_transps %>% get_two_Entrez_gene_lists %>% .[['trns']]) -> Flux_trns
                                  
                                  volcano_panel <- ggarrange(make_volcano(Flux_rxns, labSize = labSize_1, subtitle = 'Reactions', pValue_cutoff = pValue_cutoff), 
                                                             make_volcano(Flux_trns, labSize = labSize_2, subtitle = 'Transporters', pValue_cutoff=pValue_cutoff), nrow = 1, widths = widths, common.legend = T, legend = common.legend.pos)
                                  return(volcano_panel)}




C_volcano  <- make_volcano_panel(Concentration_rxns_and_transps, 3,3, c(1,1))
F_volcano  <- make_volcano_panel(Flux_rxns_and_transps, 2,2, pValue_cutoff = 0.01, common.legend.pos = 'none')
CF_volcano <- make_volcano_panel(FluxConcentration_rxns_and_transps, 2,2, c(1,1), common.legend.pos = 'none')
```


```{r fig.height=2.5, fig.width=10, message=FALSE, warning=FALSE}
Concentration_rxns_and_transps %>% get_two_Entrez_gene_lists %>% purrr::set_names(c("Reactions","Transporters")) %>% 
  compareCluster(fun='enrichPathway', pvalueCutoff=1e-3, qvalueCutoff=1e-3)-> enrich_output
enrich_output %>% dotplot(showCategory = 10, font.size = 7, label_format =90)+
   theme( 
    legend.text=element_text(size=6),
    legend.position = "bottom",
    #legend.box = "vertical",
    text = element_text(size=6)) -> C_enrichPathway
#ggarrange(C_enrichPathway, C_volcano, nrow = 1) -> upper_panel
```

```{r fig.height=3.5, fig.width=10, message=FALSE, warning=FALSE}
Flux_rxns_and_transps %>% get_two_Entrez_gene_lists %>% purrr::set_names(c("Reactions","Transporters")) %>% 
  compareCluster(fun='enrichPathway', pvalueCutoff=1e-3, qvalueCutoff=1e-3)-> enrich_output
enrich_output %>% dotplot(showCategory = 10, font.size = 7, label_format =90)+
   theme( 
    legend.text=element_text(size=6),
    legend.position = "bottom",
    #legend.box = "vertical",
    text = element_text(size=6)) -> F_enrichPathway
#ggarrange(F_enrichPathway, F_volcano, nrow = 1, widths = c(1,1.2)) -> middle_panel
```


```{r fig.height=2.5, fig.width=10, message=FALSE, warning=FALSE}
FluxConcentration_rxns_and_transps %>% get_two_Entrez_gene_lists %>% purrr::set_names(c("Reactions","Transporters")) %>% 
  compareCluster(fun='enrichPathway', pvalueCutoff=1e-3, qvalueCutoff=1e-3)-> enrich_output
enrich_output %>% dotplot(showCategory = 10, font.size = 7, label_format =90)+
   theme( 
    legend.text=element_text(size=6),
    legend.position = "bottom",
    #legend.box = "vertical",
    text = element_text(size=6)) -> FC_enrichPathway
#ggarrange(FC_enrichPathway, CF_volcano, nrow = 1, widths = c(1,1.2)) -> lower_panel
```




```{r fig.height=10, fig.width=12, message=FALSE, warning=FALSE}
enrichment_panel <-  ggarrange(C_enrichPathway, F_enrichPathway, FC_enrichPathway, ncol = 1, common.legend = T, heights = c(.7,1,1), labels = c("a","c","e"))
volcanos_panel   <- ggarrange(C_volcano, F_volcano, CF_volcano, ncol = 1, common.legend = T, heights = c(.8,1.3,1), labels = c("b","d","f"))


ggarrange(enrichment_panel, volcanos_panel, nrow = 1, widths = c(1,1.8)) -> full_panel
```


```{r}
setwd("/DeepenData/Repos/geometric_cobra")
ggsave("./results/figures/Figure_4.png", full_panel, height = 10, width = 13.5, bg="white", dpi = 400)

```



```{r}
get_DEG_table <- function(rxns_and_transps, gene_set){
              get_processed_results(annotated_results, rxns_and_transps %>% get_two_Entrez_gene_lists %>% .[[gene_set]]) -> DEG_table
              return(DEG_table)
}


get_DEG_table(Concentration_rxns_and_transps, "rxns")     %>% filter(padj < .05 & abs(log2FoldChange) > 0.1) -> DEGs_rxns_C
get_DEG_table(Concentration_rxns_and_transps, "trns")     %>% filter(padj < .05 & abs(log2FoldChange) > 0.1) -> DEGs_trns_C
get_DEG_table(Flux_rxns_and_transps, "rxns")              %>% filter(padj < .01 & abs(log2FoldChange) > 0.1) -> DEGs_rxns_F
get_DEG_table(Flux_rxns_and_transps, "trns")              %>% filter(padj < .01 & abs(log2FoldChange) > 0.1) -> DEGs_trns_F
get_DEG_table(FluxConcentration_rxns_and_transps, "rxns") %>% filter(padj < .05 & abs(log2FoldChange) > 0.1) -> DEGs_rxns_CF
get_DEG_table(FluxConcentration_rxns_and_transps, "trns") %>% filter(padj < .05 & abs(log2FoldChange) > 0.1) -> DEGs_trns_CF
```


```{r}
get_Biological_Processes <- function(DEGs){
  temp <- getBM(attributes=c('hgnc_symbol',"entrezgene_id", 'entrezgene_description','namespace_1003','name_1006', 'definition_1006'),filters ='hgnc_symbol',values =DEGs$hgnc_symbol, mart = Hs.ensembl)
temp %>% dplyr::filter(namespace_1003 == "biological_process") -> df
df %>% dplyr::select(c(hgnc_symbol, entrezgene_description, entrezgene_id, name_1006)) %>% nest_by(hgnc_symbol, entrezgene_description, entrezgene_id) %>% mutate(data =paste0( purrr::flatten_chr(data) , collapse = ', ')) %>%dplyr::rename('Biological Processes' = data) -> df_annot
return(df_annot)
}
Biological_Processes <- map(list(DEGs_rxns_C, DEGs_trns_C, DEGs_rxns_F, DEGs_trns_F, DEGs_rxns_CF, DEGs_trns_CF),get_Biological_Processes)

```


```{r fig.height=2, fig.width=25, message=FALSE, warning=FALSE}
library(openxlsx)
setwd("/DeepenData/Repos/geometric_cobra")


xlsx_path <- "./results/genes/Supplementary_Table_1_Differential_expressed_genes.xlsx"

openxlsx::write.xlsx(Biological_Processes[[1]], file = xlsx_path,  sheetName = "s1_reactions_from_concentration", append = T)

add_new_sheet <- function(xlsx_path, sheet_name, data_to_sheet ){
wb <- loadWorkbook(xlsx_path)
addWorksheet(wb,sheet_name)
writeData(wb,sheet_name,data_to_sheet)
saveWorkbook(wb,xlsx_path,overwrite = TRUE)}

add_new_sheet(xlsx_path,"s2_transport_from_concentration",Biological_Processes[[2]])
add_new_sheet(xlsx_path,"s3_reactions_from_flux",Biological_Processes[[3]])
add_new_sheet(xlsx_path,"s4_transport_from_flux",Biological_Processes[[4]])
add_new_sheet(xlsx_path,"s5_reactions_from_conc_and_flux",Biological_Processes[[5]])
add_new_sheet(xlsx_path,"s6_transport_from_conc_and_flux",Biological_Processes[[6]])

```





